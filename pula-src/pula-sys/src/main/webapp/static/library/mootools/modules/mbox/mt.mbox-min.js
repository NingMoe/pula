var IframeShim=new Class({Implements:[Options,Events],options:{name:"",className:"iframeShim",display:false,zIndex:null,margin:0,offset:{x:0,y:0},browsers:(Browser.Engine.trident4||(Browser.Engine.gecko&&!Browser.Engine.gecko19&&Browser.Platform.mac)),onInject:$empty},initialize:function(b,a){this.setOptions(a);if(this.options.offset&&this.options.offset.top){this.options.offset.y=this.options.offset.top}if(this.options.offset&&this.options.offset.left){this.options.offset.x=this.options.offset.left}this.element=$(b);this.makeShim();return},makeShim:function(){this.shim=new Element("iframe");this.id=this.options.name||new Date().getTime()+"_shim";if(this.element.getStyle("z-Index").toInt()<1||isNaN(this.element.getStyle("z-Index").toInt())){this.element.setStyle("z-Index",999)}var b=this.element.getStyle("z-Index")-1;if($chk(this.options.zIndex)&&this.element.getStyle("z-Index").toInt()>this.options.zIndex){b=this.options.zIndex}this.shim.setStyles({position:"absolute",zIndex:b,border:"none",filter:"progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)"}).setProperties({src:"javascript:void(0);",frameborder:"0",scrolling:"no",id:this.id}).addClass(this.options.className);this.element.store("shim",this);var a=function(){this.shim.inject(document.body);if(this.options.display){this.show()}else{this.hide()}this.fireEvent("inject")};if(this.options.browsers){if(Browser.Engine.trident&&!IframeShim.ready){window.addEvent("load",a.bind(this))}else{a.run(null,this)}}},position:function(c){if(!this.options.browsers||!IframeShim.ready){return this}if(c){this.shim.setStyles({width:c.width,height:c.height,top:c.top,left:c.left})}else{var b=this.element.getStyles("display","visibility","position");this.element.setStyles({display:"block",position:"absolute",visibility:"hidden"});var a=this.element.getSize();var d=this.element.getPosition();this.element.setStyles(b);if($type(this.options.margin)){a.x=a.x-(this.options.margin*2);a.y=a.y-(this.options.margin*2);this.options.offset.x+=this.options.margin;this.options.offset.y+=this.options.margin}this.shim.setStyles({width:a.x,height:a.y,top:d.y,left:d.x})}return this},hide:function(){if(this.options.browsers){this.shim.setStyle("display","none")}return this},show:function(a){if(!this.options.browsers){return this}this.shim.setStyle("display","block");return this.position(a)},dispose:function(){if(this.options.browsers){this.shim.dispose()}return this}});window.addEvent("load",function(){IframeShim.ready=true});var Overlay=new Class({Implements:[Options,Events],getOptions:function(){return{useFx:false,name:"",duration:200,colour:"#000",opacity:0.2,zIndex:99,hasShim:true,container:document.body,onClick:$empty}},initialize:function(a){this.setOptions(this.getOptions(),a);this.options.container=$(this.options.container);this.container=new Element("div").setProperty("id",this.options.name+"_overlay").setStyles({position:"absolute",left:"0",top:"0",width:"100%",height:"100%",backgroundColor:this.options.colour,zIndex:this.options.zIndex,opacity:this.options.opacity}).inject(this.options.container);if(this.options.hasShim){this.shim=new IframeShim(this.container)}this.options.useFx?this.fade=new Fx.Tween(this.container,{property:"opacity",duration:this.options.duration}).set(0):this.fade=null;this.container.setStyle("display","none");this.container.addEvent("click",function(){this.fireEvent("click")}.bind(this));window.addEvent("resize",this.position.bind(this));return this.position()},position:function(){if(this.options.container==document.body){var a=window.getScrollHeight()+"px";this.container.setStyles({top:"0px",height:a})}else{var b=this.options.container.getCoordinates();this.container.setStyles({top:b.top+"px",height:b.height+"px",left:b.left+"px",width:b.width+"px"})}},show:function(){this.container.setStyle("display","");if(this.fade){this.fade.cancel().start(this.options.opacity)}if(this.shim){this.shim.show()}return this.position()},hide:function(a){if(this.fade){this.fade.cancel().start(0)}this.container.setStyle("display","none");if(this.shim){this.shim.hide()}if(a){this.dispose()}return this},dispose:function(){this.container.dispose();if(this.shim){this.shim.dispose()}}});var Mbox={presets:{marginImage:{x:50,y:75},width:"auto",height:"auto",url:false,type:"ele",ajax:false,ajaxAttr:"href",ajaxOptions:{},title:"提示框",ensure:"确定",cancel:"取消",clostxt:"×",loadimg:"http://www.zhangxinxu.com/study/image/loading.gif",overlay:true,opacity:0.35,hasShim:true,overlayClosable:false,reposition:true,closable:true,titleable:true,optable:false,zIndex:999,time:0,useFx:false,openFrom:null,resizeFx:{},onShow:$empty,onClose:$empty},initialize:function(a){this.options={};this.setOptions(this.presets,a||{});this.build();this.bound={window:this.reposition.bind(this,[null]),close:this.close.bind(this),key:this.onKey.bind(this)};this.isOpen=this.elementObj=false;return this},build:function(){if(!this.overlay){this.overlay=new Overlay({name:"mbox",hasShim:this.options.hasShim,opacity:this.options.opacity,onClick:(this.options.overlayClosable)?this.close.bind(this):null})}if(!$("mboxWindow")){var d='<div id="mboxBar" class="mbox_bar">'+this.options.title+'</div><a href="javascript:;" id="mboxBtnClose" class="mbox_close" title="关闭">'+this.options.clostxt+'</a><div id="mboxContent" class="mbox_cont"></div><div id="mboxOperate" class="mbox_operate" style="display:none;"></div>';var e=this.options.openFrom,c,b,a;if($type(e)==="element"&&e){c=e.getPosition().y,a=e.getPosition().x,b=e.getSize().x}else{c=250,b=400,a=(window.getSize().x-b)/2}this.win=new Element("div",{id:"mboxWindow","class":"mbox_win",styles:{width:b,top:c,left:a,position:"absolute",zIndex:this.options.zIndex+2,visibility:"hidden"}}).set("html",d);document.body.adopt(this.win)}this.bar=$("mboxBar");this.closbtn=$("mboxBtnClose");this.cont=$("mboxContent");this.opt=$("mboxOperate");return this},assign:function(b,a){b.addEvent("click",function(c){new Event(c).stop();Mbox.open(a,this)})},open:function(a,b){a=a||{},this.initialize(a);if($type(b)==="element"){this.element=$(b);this.options.url=this.element.getProperty(this.options.ajaxAttr)||this.options.url}this.getContent()},remind:function(b,a){if(b){this.initParams();a=a||{};this.initialize(a);this.getContent('<div class="mbox_remind">'+b+"</div>");this.closbtn.setStyle("visibility","hidden");this.bar.setStyle("display","none");this.opt.setStyle("display","none");var c=this.options.time.toInt();if(c>0){this.close.delay(c,this)}}return this},alert:function(c,b,a){if(!c){return this}this.initParams();a=a||{};this.initialize(a);this.getContent('<div class="mbox_alert">'+c+"</div>");this.opt.setStyle("display","block");this.bar.setStyle("display","block");this.AlertBtnOk=new Element("input",{id:"mboxAlertOk","class":"mbox_btn_sure",type:"submit",value:this.options.ensure});this.AlertBtnOk.addEvent("click",function(){this.close();if($type(b)==="function"){b.call(this)}}.bind(this));this.opt.empty().adopt(this.AlertBtnOk);if($("mboxAlertOk")&&$("mboxAlertOk").getStyle("display")!=="none"){$("mboxAlertOk").focus()}},confirm:function(d,c,b,a){if(!d){return this}this.initParams();a=a||{};this.initialize(a);this.getContent('<div class="mbox_alert">'+d+"</div>");this.opt.setStyle("display","block");this.bar.setStyle("display","block");this.ConfirmBtnOk=new Element("input",{id:"mboxConfirmOk","class":"mbox_btn_sure",type:"submit",value:this.options.ensure});this.ConfirmBtnCancel=new Element("input",{id:"mboxConfirmCancel","class":"mbox_btn_cancel",type:"button",value:this.options.cancel});this.opt.empty().adopt(this.ConfirmBtnOk,this.ConfirmBtnCancel);this.ConfirmBtnOk.addEvent("click",function(){if($type(c)==="function"){c.call(this)}}.bind(this));this.ConfirmBtnCancel.addEvent("click",function(){this.close();if($type(b)==="function"){c.call(this)}}.bind(this));if($("mboxConfirmOk")&&$("mboxConfirmOk").getStyle("display")!=="none"){$("mboxConfirmOk").focus()}},loading:function(a){this.initialize({});a=a||'<div class="mbox_loading"><img src="'+this.options.loadimg+'" class="mbox_loading_image" />加载中...</div>';this.getContent(a);this.closbtn.setStyle("visibility","hidden");this.bar.setStyle("display","none");this.opt.setStyle("display","none");return this},close:function(){if(this.isOpen){this.isOpen=false;if($type(this.options.onClose)==="function"){this.options.onClose.call(this)}if(this.overlay&&this.options.overlay){this.overlay.dispose();this.overlay=null}if(this.elementObj){document.body.adopt(this.elementObj.setStyle("display","none"))}this.cont.empty();this.opt.empty();this.win.setStyle("visibility","hidden");this.closbtn.setStyle("visibility","hidden");if(this.element){this.element=null}this.initParams();this.toggleListeners();this.options.onShow=$empty;this.options.onClose=$empty;if(this.fx){this.fx=null}}return false},initParams:function(){this.options={};this.setOptions(this.presets)},toggleListeners:function(b){var a=(b)?"addEvent":"removeEvent";this.closbtn[a]("click",this.bound.close);document[a]("keydown",this.bound.key);if(this.options.reposition){window[a]("resize",this.bound.window)[a]("scroll",this.bound.window)}},getContent:function(d){this.toggleListeners(true);if(d){return this.applyContent(d)}var e=this.options.type,a=this.options.url,g=Number(this.options.width)||600,f=Number(this.options.height)||400;if(!a){return false}if(this.options.ajax){this.loading();switch(e){case"image":var c=new Image(),h=a;c.onload=function(){var m=document.getSize(),l;m.x-=this.options.marginImage.x;m.y-=this.options.marginImage.y;l={x:c.width,y:c.height};for(var k=2;k--;){if(l.x>m.x){l.y*=m.x/l.x;l.x=m.x}else{if(l.y>m.y){l.x*=m.y/l.y;l.y=m.y}}}l.x=l.x.toInt();l.y=l.y.toInt();this.applyContent('<img class="mbox_ajax_image" src="'+h+'" width="'+l.x+'" height="'+l.y+'" />')}.bind(this);c.onerror=function(){this.alert("图片加载没有成功！")}.bind(this);c.src=h;break;case"iframe":var b={src:a,styles:{width:g,height:f,background:"url("+this.options.loadimg+") no-repeat center",border:0},"class":"mbox_ajax_iframe",frameborder:0};this.applyContent(new IFrame(b));break;case"ajax":var j=this;new Request.HTML($merge({method:"get"},this.options.ajaxOptions)).addEvents({onFailure:this.onError.bind(this),onComplete:function(l,k,n,m){j.applyContent(n)}}).send({url:a});break;case"swf":var i='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="'+g+'" height="'+f+'" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"><param name="quality" value="high" /><param name="src" value="'+a+'" /><param name="wmode" value="transparent" /><embed type="application/x-shockwave-flash" wmode="transparent" width="'+g+'" height="'+f+'" src="'+a+'" quality="high"></embed></object>';this.applyContent(i);break;default:return this.applyContent(a)}}else{if($type(a)==="string"){a=a.replace(/^#/,"");if($(a)){a=$(a)}}return this.applyContent(a)}},applyContent:function(b){var a=this.cont.getStyle("position");if($type(b)==="string"){this.cont.set("html",b).setStyle("position","absolute")}else{if($type(b)==="element"){this.elementObj=b;this.cont.empty().adopt(b.setStyle("display","block")).setStyle("position","absolute")}else{return this}}this.winsize=this.cont.getSize();this.cont.setStyle("position",a);this.bar.set("html",this.options.title);this.closbtn.set("html",this.options.clostxt);this.showControl();this.reposition();this.win.setStyle("visibility","visible");this.isOpen=true;if($type(this.options.onShow)==="function"){this.options.onShow.call(this)}return this},showControl:function(){if(this.options.closable){this.closbtn.setStyle("visibility","visible")}else{this.closbtn.setStyle("visibility","hidden")}if(this.overlay&&this.options.overlay){this.overlay.show()}if(this.options.titleable){this.bar.setStyle("display","block")}else{this.bar.setStyle("display","none")}if(this.options.optable){this.opt.setStyle("display","block")}else{this.opt.setStyle("display","none")}},reposition:function(e){var n=document,r=window,j=this.win,o=r.getSize();var f=this.winsize.x||j.getSize().x,b=j.getScrollSize().y,g=(r.XMLHttpRequest)?false:true,m=o.x,l=o.y,k=n.getScroll().y,p=b<l,a,s,r=this.options.width.toInt(),i=this.options.height.toInt();b=i||b,f=r||f;j.setStyle("height",b);a=(m-f)/2;s=(l-b)/2+k;if(g||!this.options.reposition){s=p?((l-b)/2+k):(50+k)}else{s=p?((l-b)/2):50;j.setStyle("position","fixed")}var q={width:f,height:b,left:a,top:s};if(this.options.useFx||e===true){this.fx={win:new Fx.Morph(this.win,$merge({duration:750,transition:Fx.Transitions.Quint.easeOut,link:"cancel",unit:"px",onComplete:function(){if(!i){j.setStyle("height","auto")}}},this.options.resizeFx))}}if(this.fx&&!g){this.fx.win.cancel().start(q)}else{j.setStyles(q);if(!i){j.setStyle("height","auto")}}},onError:function(){this.alert("加载出了点小问题。")},onKey:function(a){switch(a.key){case"esc":if(this.closbtn.getStyle("visibility")==="visible"){this.close(a)}case"up":case"down":return false}},extend:function(a){return $extend(this,a)}};Mbox.extend(new Options);